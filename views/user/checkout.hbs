

<div class="container col-8 my-5 br-2 rounded">
  <div class="row g-3">
    <div class="col-4 order-md-last mt-5">
      <h4 class="d-flex justify-content-between align-item-center">
        <span class="text-muted">Your Cart</span>
        {{! <span class="badge bg-secondary rounded-pill">3</span> }}
      </h4>
      <ul class="list-group">
        {{! <li class="list-group-item d-flex justify-content-between">
                        <div>
                            <h6>Product name</h6>
                            <span class="text-muted">Brief Description</span>
                        </div>
                        <span class="text-muted">Rs 500</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <div>
                            <h6>Second Product</h6>
                            <span class="text-muted">Brief Description</span>
                        </div>
                        <span class="text-muted">Rs 200</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <div>
                            <h6>Third Product</h6>
                            <span class="text-muted">Brief Description</span>
                        </div>
                        <span class="text-muted">Rs 600</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <div>
                            <h6 class="text-success">Promo Code</h6>
                            <span class="text-muted">Sale10</span>
                        </div>
                        <span class="text-muted">Rs 100</span>
                    </li> }}
        <li class="list-group-item d-flex justify-content-between">
          <div>
            <h6>Total (Rs)</h6>
          </div>
          <span class="text-muted">Rs {{total}} </span>
        </li>
      </ul>
    </div>
    <div class="col-8">
      <h4>Shipping Address</h4>
      <form id="check-out-form" method="POST">
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label" for="firstname">First Name</label>
            <input type="text" name="FirstName" id="firstname" class="form-control" required/>
            <input
              type="text"
              name="userId"
              value="{{user._id}}"
              hidden
            />
          </div>
          <div class="col-6 mb-2">
            <label class="form-label" for="lastname">Last name</label>
            <input type="text"  name="LastName" id="lastname" class="form-control" required/>
          </div>
          <div class="col-12 mb-2">
            <label class="from-label" for="username">Address</label>
            <div class="input-group">
              <input type="text" name="Address" class="form-control" id="address" required/>
            </div>
          </div>
          <div class="col-12 mb-2">
            <label class="form-label" for="email">Apartment
              <span class="text-muted"> (Optional)</span>
            </label>
            <input type="text" id="apartment" name="Apartment" class="form-control" />
          </div>
          <div class="col-6 mb-2">
            <label class="form-label" for="address">Zipcode </label>
            <input type="number" id="zipcode" name="Zipcode" class="form-control" required/>
          </div>
          <div class="col-6 mb-2">
            <label class="form-label" for="address">State </label>
            <input type="text" name="State" id="state" class="form-control" required/>
          </div>
          <div class="col-6 mb-2">
            <label class="form-label" for="address">Country </label>
            <input type="text" name="Country" id="country" class="form-control" required/>
          </div>
          <div class="col-6 mb-2">
            <label class="form-label" for="address">Phone Number </label>
            <input type="text" name="PhoneNumber" id="phoneNumber" class="form-control" required/>
          </div>
          
          
        </div>
        <hr />

        <h4>Payment</h4>
        <div class="form-check m-2">
          <input
            class="form-check-input"
            type="radio"
            name="PaymentMethod"
            value="COD"
            id="flexRadioDefault1"
            checked
          />
          <label class="form-check-label" for="flexRadioDefault1">
            Cash on delivery
          </label>
        </div>
        <div class="form-check m-2">
          <input
            class="form-check-input"
            type="radio"
            name="PaymentMethod"
            value="RazorPay"
            id="flexRadioDefault2"
          />
          <label class="form-check-label" for="flexRadioDefault2">
            via razor pay
          </label>
        </div>
        <div class="form-check m-2">
          <input
            class="form-check-input"
            type="radio"
            name="PaymentMethod"
            value="PayPal"
            id="flexRadioDefault2"
          />
          <label class="form-check-label" for="flexRadioDefault2">
            via PayPal
          </label>
        </div>
        
        <hr />
        <button type="submit" class="btn btn-theme btn-sm">Place Order</button>
      </form>
    </div>
  </div>
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script> 
<script>
  $("#check-out-form").submit((event) => {
  event.preventDefault();
  $.ajax({
    url: "/checkout-form",
    method: "post",
    data: $("#check-out-form").serialize(),
    success: (response) => {
      if (response.cod) {
        swal('Order placed successfully').then(()=>{
          location.href = "/user-orders-list";
        })
      }else if(response.razorpay == true){
          razorpayPayment(response)
      }else if (response.payer.payment_method = 'paypal'){
           for (let i = 0; i < response.links.length; i++) {
          if (response.links[i].rel === "approval_url") {
            location.href = response.links[i].href;
          }
        }
      }
      
    },
  });
});


function razorpayPayment(order){
  console.log(order)
  var options = {
    key: "rzp_test_8JdNiiJaGLJLpv", // Enter the Key ID generated from the Dashboard
    amount: order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    currency: "INR",
    name: "Cozmo",
    description: "Test Transaction",
    image: "https://example.com/your_logo",
    order_id: order.id,  //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    handler: function (response){
        
        verifyPayment(response, order)
    },
    prefill: {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9999999999"
    },
    notes: {
        "address": "Razorpay Corporate Office"
    },
    theme: {
        "color": "#3399cc"
    }
};

var rzp1 = new Razorpay(options);
  rzp1.open();
  
}

function verifyPayment(payment, order){
  console.log('hiiiii')
    $.ajax({
      url: '/verify-payment', 
      data: {
        payment,
        order
      },
      method: 'post',
      success: (response)=>{
        if (response.status){
          location.href='/user-orders-list'
        }else {
          alert('payment failed')
        }
      }

    })
}

</script>